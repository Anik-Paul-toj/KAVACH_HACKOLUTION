(()=>{"use strict";class e{static calculateScore(e,t=[]){let a=100;return a-=Math.min(5*e.length,40),a-=3*e.filter((e=>["advertising","social","analytics"].includes(e.category))).length,a-=Math.min(8*t.length,30),Math.max(0,Math.min(100,a))}}const t={"doubleclick.net":{category:"advertising",name:"Google DoubleClick"},"googletagmanager.com":{category:"analytics",name:"Google Tag Manager"},"facebook.com":{category:"social",name:"Facebook Pixel"},"google-analytics.com":{category:"analytics",name:"Google Analytics"},"connect.facebook.net":{category:"social",name:"Facebook Connect"},"amazon-adsystem.com":{category:"advertising",name:"Amazon Advertising"},"twitter.com":{category:"social",name:"Twitter Analytics"},"linkedin.com":{category:"social",name:"LinkedIn Insights"}};function a(e){return new Promise((t=>{let a=0;const o=setInterval((()=>{a++,window.FingerprintJS?(clearInterval(o),async function(){try{const a=await window.FingerprintJS.load({apiKey:e,region:"ap"}),o=await a.get({extendedResult:!0});t({success:!0,data:{visitorId:o.visitorId,confidence:o.confidence,components:o.components,requestId:o.requestId,timestamp:Date.now()}})}catch(e){t({success:!1,error:`Fingerprinting failed: ${e.message}`})}}()):a>50&&(clearInterval(o),t({success:!1,error:"FingerprintJS object not found after script injection."}))}),100)}))}new class{constructor(){this.siteData=new Map,this.blockedRequests=new Map,this.privacyPolicyUrls=new Map,console.log("üöÄ Kavach Background Service starting..."),this.setupRequestBlocking(),this.setupTabListeners(),this.setupMessageListeners(),console.log("‚úÖ Kavach Background Service initialized")}safeParseURL(e){try{return e&&"string"==typeof e?new URL(e):(console.warn("‚ùå Invalid URL input:",e),null)}catch(t){return console.warn("‚ùå Failed to parse URL:",e,t),null}}getDomainFromURL(e){const t=this.safeParseURL(e);return t?t.hostname:null}setupRequestBlocking(){console.log("üõ°Ô∏è Kavach: Setting up request blocking..."),chrome.webRequest.onBeforeRequest.addListener((e=>{if(console.log("üåê Request detected:",e.url,"Type:",e.type,"Initiator:",e.initiator),"main_frame"===e.type)return{};const t=this.safeParseURL(e.url),a=e.initiator?this.safeParseURL(e.initiator):null;return t&&a&&t.hostname!==a.hostname&&(console.log("üö® Third-party request:",t.hostname,"from",a.hostname),this.trackThirdPartyRequest(a.hostname,t.hostname,e.type)),{}}),{urls:["<all_urls>"]},["requestBody"])}setupTabListeners(){console.log("üëÇ Setting up tab listeners..."),chrome.tabs.onUpdated.addListener(((e,t,a)=>{"complete"===t.status&&a.url&&this.isValidHttpUrl(a.url)&&(console.log("üìÑ Tab completed loading:",a.url),this.initializeSiteData(a.url))})),chrome.tabs.onActivated.addListener((async e=>{try{const t=await chrome.tabs.get(e.tabId);t.url&&this.isValidHttpUrl(t.url)&&(console.log("üîÑ Tab activated:",t.url),this.initializeSiteData(t.url))}catch(e){console.log("‚ùå Error getting active tab:",e)}}))}isValidHttpUrl(e){try{const t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch{return!1}}trackThirdPartyRequest(a,o,i){console.log("üìä Tracking third-party request:",{sourceDomain:a,trackerDomain:o,requestType:i});let r=this.siteData.get(a);if(!r&&(console.log("‚ùå No site data found for:",a,"- Creating new site data"),this.initializeSiteDataForDomain(a),r=this.siteData.get(a),!r))return void console.log("‚ùå Failed to create site data for:",a);const s=r.trackers.find((e=>e.domain===o));if(s)s.count++,console.log("üìà Updated tracker count:",o,s.count);else{const e=t[o],a={domain:o,count:1,category:e?.category||"unknown",blocked:this.isTrackerBlocked(o)};r.trackers.push(a),console.log("üÜï New tracker detected:",a)}const n=r.trustScore;r.trustScore=e.calculateScore(r.trackers),console.log("üéØ Trust score updated:",n,"‚Üí",r.trustScore),this.updateDataFlow(r,a,o),this.siteData.set(a,r)}isTrackerBlocked(e){return["doubleclick.net","googletagmanager.com","facebook.com/tr"].some((t=>e.includes(t)))}updateDataFlow(e,t,a){if(e.dataFlow.nodes.find((e=>e.id===t))||e.dataFlow.nodes.push({id:t,domain:t,type:"source",position:{x:100,y:100}}),!e.dataFlow.nodes.find((e=>e.id===a))){const t=e.dataFlow.nodes.length;e.dataFlow.nodes.push({id:a,domain:a,type:"tracker",position:{x:200+100*t,y:150}})}e.dataFlow.edges.find((e=>e.from===t&&e.to===a))||e.dataFlow.edges.push({from:t,to:a,dataType:"user_data"})}initializeSiteData(e){const t=this.getDomainFromURL(e);if(t)if(console.log("üè† Initializing site data for:",t),this.siteData.has(t))console.log("‚ôªÔ∏è Site data already exists for:",t);else{const a={url:e,trustScore:100,trackers:[],dataFlow:{nodes:[],edges:[]}};this.siteData.set(t,a),console.log("‚úÖ Site data initialized:",a)}else console.warn("‚ùå Cannot initialize site data for invalid URL:",e)}initializeSiteDataForDomain(e){if(console.log("üè† Initializing site data for domain:",e),this.siteData.has(e))console.log("‚ôªÔ∏è Site data already exists for domain:",e);else{const t={url:`https://${e}`,trustScore:100,trackers:[],dataFlow:{nodes:[],edges:[]}};this.siteData.set(e,t),console.log("‚úÖ Site data initialized for domain:",t)}}async getSiteData(e){const t=this.getDomainFromURL(e);if(!t)return console.warn("‚ùå Cannot get site data for invalid URL:",e),null;this.siteData.has(t)||(console.log("üîÑ Site data not found, initializing for:",t),this.initializeSiteData(e));const a=this.siteData.get(t)||null;return console.log("üìä Getting site data for:",t,"Found:",!!a,"Trackers:",a?.trackers?.length||0),a}async toggleTrackerBlocking(e){e?await chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:["tracker_rules"]}):await chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:["tracker_rules"]})}setupMessageListeners(){chrome.runtime.onMessage.addListener(((e,t,a)=>{switch(console.log("üì® Message received:",e.action,e),e.action){case"getSiteData":return this.getSiteData(e.url).then(a),!0;case"getFingerprintScript":return this.getFingerprintScript(e.apiKey).then(a),!0;case"toggleBlocking":return this.toggleTrackerBlocking(e.enabled).then((()=>{a({success:!0})})),!0;case"analyzePrivacyPolicy":return this.analyzePrivacyPolicy(e.url).then(a),!0;case"privacyPoliciesFound":return this.storePrivacyPolicyUrls(e.currentUrl,e.urls),a({success:!0}),!0;case"debugInfo":const t={trackedDomains:Array.from(this.siteData.keys()),totalSites:this.siteData.size,siteDataSnapshot:Array.from(this.siteData.entries()).map((([e,t])=>({domain:e,trackerCount:t.trackers.length,trustScore:t.trustScore})))};return console.log("üêõ Debug info requested:",t),a(t),!0;case"runFingerprint":return e.tabId?this.handleFingerprinting(e.apiKey,e.tabId).then(a).catch((e=>a({success:!1,error:e.message}))):a({success:!1,error:"No tabId provided in the request."}),!0;case"performOptOut":return this.performComprehensiveOptOut(e.url,e.tabId).then(a).catch((e=>a({success:!1,error:e.message}))),!0}}))}storePrivacyPolicyUrls(e,t){const a=this.getDomainFromURL(e);a?this.privacyPolicyUrls.set(a,t):console.warn("‚ùå Cannot store privacy policy URLs for invalid URL:",e)}async analyzePrivacyPolicy(e){const t=this.getDomainFromURL(e);if(!t)return console.warn("‚ùå Cannot analyze privacy policy for invalid URL:",e),{error:"Invalid URL provided"};const a=this.privacyPolicyUrls.get(t)||[];if(0===a.length){const e=["/privacy","/privacy-policy","/privacy.html","/privacy.php","/privacy.aspx","/terms","/terms-of-service","/terms-and-conditions","/legal/privacy","/legal/terms","/help/privacy","/support/privacy","/about/privacy","/policies/privacy","/privacy-statement","/privacy-notice","/data-protection","/cookie-policy","/gdpr","/ccpa"],o=[`https://${t}`,`https://www.${t}`,`http://${t}`,`http://www.${t}`];for(const t of o){for(const o of e)try{const e=new AbortController,i=setTimeout((()=>e.abort()),5e3),r=await fetch(`${t}${o}`,{method:"HEAD",signal:e.signal});if(clearTimeout(i),r.ok){a.push(`${t}${o}`);break}}catch(e){}if(a.length>0)break}}if(0===a.length)return{score:50,risks:["No privacy policy found"],summary:"Unable to locate a privacy policy for this website.",dataSharing:[]};try{const e=await this.fetchPrivacyPolicyText(a[0]),o=await this.performPrivacyAnalysis(e,t),i=this.siteData.get(t);return i&&(i.privacyAnalysis=o,this.siteData.set(t,i)),o}catch(e){return console.error("Privacy policy analysis failed:",e),{score:30,risks:["Failed to analyze privacy policy"],summary:"Privacy policy analysis failed due to technical issues.",dataSharing:[]}}}async fetchPrivacyPolicyText(e){try{const t=await fetch(e);let a=(await t.text()).replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"");a=a.replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi,"");let o=a.replace(/<[^>]*>/g," ");return o=o.replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'"),o=o.replace(/\s+/g," ").trim(),o}catch(t){throw console.error("Failed to fetch privacy policy:",e,t),new Error(`Failed to fetch privacy policy: ${t instanceof Error?t.message:"Unknown error"}`)}}async performPrivacyAnalysis(e,t){const a=e.toLowerCase(),o=[],i=[];let r=80;const s={"Data Selling":{keywords:["sell","sale","sold","monetize","revenue from data","third-party purchasers"],penalty:25,context:["personal information","user data","your data"]},"Cross-site Tracking":{keywords:["track across","follow you","behavioral tracking","cross-site","cross-platform"],penalty:20,context:["websites","platforms","services"]},"Vague Data Retention":{keywords:["indefinitely","as long as necessary","business purposes","legal requirements"],penalty:15,context:["retain","keep","store","maintain"]},"Limited User Control":{keywords:["cannot delete","unable to remove","permanent","irrevocable"],penalty:20,context:["account","data","information"]},"Broad Data Collection":{keywords:["all information","any data","everything","comprehensive"],penalty:15,context:["collect","gather","obtain"]},"Weak Consent Mechanisms":{keywords:["deemed consent","implied consent","continued use","by using"],penalty:18,context:["agree","consent","acceptance"]},"Data Sharing with Law Enforcement":{keywords:["law enforcement","government agencies","legal process","subpoena"],penalty:10,context:["share","provide","disclose"]},"Location Tracking":{keywords:["precise location","gps","geolocation","whereabouts"],penalty:15,context:["track","collect","monitor"]},"Biometric Data Collection":{keywords:["biometric","fingerprint","facial recognition","voice print"],penalty:20,context:["collect","process","store"]},"Children Data Collection":{keywords:["under 13","children","minors","parental consent"],penalty:25,context:["collect","process","target"]}};for(const[e,t]of Object.entries(s)){const i=t.keywords.some((e=>a.includes(e))),s=t.context.some((e=>a.includes(e)));i&&s&&(o.push(e),r-=t.penalty)}const n={Google:["google","alphabet","youtube","gmail","google analytics","doubleclick"],"Meta/Facebook":["facebook","meta","instagram","whatsapp","messenger"],Amazon:["amazon","aws","amazon web services","alexa"],Microsoft:["microsoft","office 365","azure","bing"],Apple:["apple","icloud","itunes","app store"],"TikTok/ByteDance":["tiktok","bytedance"],"Twitter/X":["twitter","x corp"],"Advertising Networks":["adsense","admob","advertising partners","ad networks"],"Analytics Providers":["analytics","tracking","measurement","statistics"],"Data Brokers":["data broker","information broker","third-party data"],"Marketing Partners":["marketing partners","promotional partners","affiliates"],"Government Agencies":["government","law enforcement","regulatory agencies"]};for(const[e,t]of Object.entries(n))t.some((e=>a.includes(e)))&&!i.includes(e)&&i.push(e);const c=[{keywords:["opt-out","opt out"],bonus:8,description:"Clear opt-out mechanisms"},{keywords:["delete account","data deletion"],bonus:10,description:"Account deletion available"},{keywords:["anonymize","anonymization"],bonus:6,description:"Data anonymization"},{keywords:["encryption","encrypted"],bonus:8,description:"Data encryption"},{keywords:["minimal data","data minimization"],bonus:12,description:"Data minimization principle"},{keywords:["user control","user choice"],bonus:8,description:"User control emphasized"},{keywords:["transparent","transparency"],bonus:6,description:"Transparency commitment"},{keywords:["third-party audits","security audits"],bonus:10,description:"Security auditing"},{keywords:["gdpr","ccpa","privacy rights"],bonus:12,description:"Privacy law compliance"}],l=[];for(const e of c)e.keywords.some((e=>a.includes(e)))&&(r+=e.bonus,l.push(e.description));const d={"Social Media":["social","posts","friends","connections"],"E-commerce":["purchase","shopping","payment","transactions"],Financial:["financial","banking","credit","loan"],Healthcare:["health","medical","patient","treatment"],Education:["student","academic","education","learning"]};let p="General";for(const[e,t]of Object.entries(d))if(t.some((e=>a.includes(e)))){p=e,"Financial"!==e&&"Healthcare"!==e||(r-=5);break}r=Math.max(0,Math.min(100,r));let u=`This ${p.toLowerCase()} privacy policy has been analyzed for comprehensive privacy practices. `;return u+=r>=80?"The policy demonstrates strong privacy protection with clear user rights, limited data sharing, and transparent practices.":r>=60?"The policy shows reasonable privacy practices but has some areas of concern regarding data collection or sharing.":r>=40?"The policy has significant privacy concerns with extensive data collection, sharing, or unclear user rights.":"The policy raises serious privacy concerns with poor user protection, extensive data sharing, or lack of user control.",l.length>0&&(u+=` Positive aspects include: ${l.slice(0,3).join(", ")}.`),{score:r,risks:o.slice(0,8),summary:u,dataSharing:[...new Set(i)].slice(0,8),industryType:p,positiveFeatures:l.slice(0,5),analysisDepth:"Enhanced AI Analysis",lastAnalyzed:(new Date).toISOString()}}async getFingerprintScript(e){const t=`https://fpnpmcdn.net/v3/${e}/loader_v3.11.10.js`;try{const e=await fetch(t);if(!e.ok)throw new Error(`Failed to fetch script: ${e.statusText}`);return{script:await e.text()}}catch(e){return console.error("Failed to fetch FingerprintJS script:",e),{error:e.message}}}async handleFingerprinting(e,t){try{await chrome.scripting.executeScript({target:{tabId:t},files:["fingerprint-agent.js"],world:"MAIN"});const o=await chrome.scripting.executeScript({target:{tabId:t},func:a,args:[e],world:"MAIN"});if(o&&o[0]&&o[0].result)return o[0].result;throw new Error("No result returned from fingerprinting script")}catch(e){return console.error("Background fingerprinting error:",e),{success:!1,error:`Failed to run fingerprinting: ${e.message}`}}}async performComprehensiveOptOut(e,t){try{const t=this.getDomainFromURL(e);if(!t)throw new Error("Invalid URL provided");console.log("üö´ Starting comprehensive opt-out for:",t),await this.addDomainToBlockList(t),this.clearDomainTrackingData(t),await this.enableEnhancedBlockingForDomain(t),this.privacyPolicyUrls.delete(t),await chrome.storage.local.set({[`optedOut_${t}`]:{timestamp:Date.now(),userInitiated:!0,comprehensive:!0}});const a=this.siteData.get(t);return a&&(a.trustScore=95,a.trackers=[],this.siteData.set(t,a)),console.log("‚úÖ Background opt-out processing completed for:",t),{success:!0,message:`Comprehensive opt-out completed for ${t}`}}catch(e){return console.error("‚ùå Background opt-out failed:",e),{success:!1,error:`Opt-out failed: ${e.message}`}}}async addDomainToBlockList(e){try{const t=(await chrome.storage.local.get(["blockedDomains"])).blockedDomains||[];t.includes(e)||(t.push(e),await chrome.storage.local.set({blockedDomains:t}),console.log("üìù Added domain to block list:",e))}catch(e){console.warn("Failed to add domain to block list:",e)}}clearDomainTrackingData(e){try{this.siteData.delete(e),Array.from(this.blockedRequests.keys()).filter((t=>t.includes(e))).forEach((e=>this.blockedRequests.delete(e))),console.log("üßπ Cleared tracking data for:",e)}catch(e){console.warn("Failed to clear domain tracking data:",e)}}async enableEnhancedBlockingForDomain(e){try{const t=[{id:Date.now(),priority:1,action:{type:"block"},condition:{initiatorDomains:[e],resourceTypes:["script","xmlhttprequest","image","media","font","websocket"]}}];(e.includes("youtube.com")||e.includes("google.com"))&&t.push({id:Date.now()+1,priority:2,action:{type:"block"},condition:{urlFilter:"*youtube.com/api/stats*",resourceTypes:["xmlhttprequest"]}},{id:Date.now()+2,priority:2,action:{type:"block"},condition:{urlFilter:"*youtube.com/youtubei/v1/log_event*",resourceTypes:["xmlhttprequest"]}},{id:Date.now()+3,priority:2,action:{type:"block"},condition:{urlFilter:"*youtube.com/ptracking*",resourceTypes:["xmlhttprequest","image"]}}),await chrome.declarativeNetRequest.updateDynamicRules({addRules:t}),console.log("üõ°Ô∏è Enhanced blocking enabled for:",e)}catch(e){console.warn("Failed to enable enhanced blocking:",e)}}}})();