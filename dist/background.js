(()=>{"use strict";class e{static calculateScore(e,t=[]){let a=100;return a-=Math.min(5*e.length,40),a-=3*e.filter((e=>["advertising","social","analytics"].includes(e.category))).length,a-=Math.min(8*t.length,30),Math.max(0,Math.min(100,a))}}const t={"doubleclick.net":{category:"advertising",name:"Google DoubleClick"},"googletagmanager.com":{category:"analytics",name:"Google Tag Manager"},"facebook.com":{category:"social",name:"Facebook Pixel"},"google-analytics.com":{category:"analytics",name:"Google Analytics"},"connect.facebook.net":{category:"social",name:"Facebook Connect"},"amazon-adsystem.com":{category:"advertising",name:"Amazon Advertising"},"twitter.com":{category:"social",name:"Twitter Analytics"},"linkedin.com":{category:"social",name:"LinkedIn Insights"}};new class{constructor(){this.siteData=new Map,this.blockedRequests=new Map,this.privacyPolicyUrls=new Map,this.setupRequestBlocking(),this.setupTabListeners(),this.setupMessageListeners()}setupRequestBlocking(){chrome.webRequest.onBeforeRequest.addListener((e=>{if("main_frame"===e.type)return{};const t=new URL(e.url),a=e.initiator?new URL(e.initiator):null;return a&&t.hostname!==a.hostname&&this.trackThirdPartyRequest(a.hostname,t.hostname,e.type),{}}),{urls:["<all_urls>"]},["requestBody"])}setupTabListeners(){chrome.tabs.onUpdated.addListener(((e,t,a)=>{"complete"===t.status&&a.url&&this.initializeSiteData(a.url)}))}trackThirdPartyRequest(a,s,i){const o=this.siteData.get(a);if(!o)return;const r=o.trackers.find((e=>e.domain===s));if(r)r.count++;else{const e=t[s];o.trackers.push({domain:s,count:1,category:e?.category||"unknown",blocked:this.isTrackerBlocked(s)})}o.trustScore=e.calculateScore(o.trackers),this.updateDataFlow(o,a,s),this.siteData.set(a,o)}isTrackerBlocked(e){return["doubleclick.net","googletagmanager.com","facebook.com/tr"].some((t=>e.includes(t)))}updateDataFlow(e,t,a){if(e.dataFlow.nodes.find((e=>e.id===t))||e.dataFlow.nodes.push({id:t,domain:t,type:"source",position:{x:100,y:100}}),!e.dataFlow.nodes.find((e=>e.id===a))){const t=e.dataFlow.nodes.length;e.dataFlow.nodes.push({id:a,domain:a,type:"tracker",position:{x:200+100*t,y:150}})}e.dataFlow.edges.find((e=>e.from===t&&e.to===a))||e.dataFlow.edges.push({from:t,to:a,dataType:"user_data"})}initializeSiteData(e){const t=new URL(e).hostname;this.siteData.has(t)||this.siteData.set(t,{url:e,trustScore:100,trackers:[],dataFlow:{nodes:[],edges:[]}})}async getSiteData(e){const t=new URL(e).hostname;return this.siteData.get(t)||null}async toggleTrackerBlocking(e){e?await chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:["tracker_rules"]}):await chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:["tracker_rules"]})}setupMessageListeners(){chrome.runtime.onMessage.addListener(((e,t,a)=>{switch(e.action){case"getSiteData":return this.getSiteData(e.url).then(a),!0;case"toggleBlocking":return this.toggleTrackerBlocking(e.enabled).then((()=>{a({success:!0})})),!0;case"analyzePrivacyPolicy":return this.analyzePrivacyPolicy(e.url).then(a),!0;case"privacyPoliciesFound":return this.storePrivacyPolicyUrls(e.currentUrl,e.urls),a({success:!0}),!0}}))}storePrivacyPolicyUrls(e,t){const a=new URL(e).hostname;this.privacyPolicyUrls.set(a,t)}async analyzePrivacyPolicy(e){const t=new URL(e).hostname,a=this.privacyPolicyUrls.get(t)||[];if(0===a.length){const e=["/privacy","/privacy-policy","/privacy.html","/terms","/terms-of-service","/legal/privacy"];for(const s of e)try{const e=await fetch(`https://${t}${s}`);if(e.ok){a.push(e.url);break}}catch(e){}}if(0===a.length)return{score:50,risks:["No privacy policy found"],summary:"Unable to locate a privacy policy for this website.",dataSharing:[]};try{const e=await this.fetchPrivacyPolicyText(a[0]),s=await this.performPrivacyAnalysis(e,t),i=this.siteData.get(t);return i&&(i.privacyAnalysis=s,this.siteData.set(t,i)),s}catch(e){return console.error("Privacy policy analysis failed:",e),{score:30,risks:["Failed to analyze privacy policy"],summary:"Privacy policy analysis failed due to technical issues.",dataSharing:[]}}}async fetchPrivacyPolicyText(e){const t=await fetch(e),a=await t.text(),s=(new DOMParser).parseFromString(a,"text/html");return s.querySelectorAll("script, style").forEach((e=>e.remove())),s.body.textContent||s.body.innerText||""}async performPrivacyAnalysis(e,t){const a=e.toLowerCase(),s=[],i=[];let o=70;a.includes("sell")&&a.includes("personal information")&&(s.push("May sell personal information to third parties"),o-=20),a.includes("track")&&a.includes("across websites")&&(s.push("Tracks users across multiple websites"),o-=15),a.includes("advertising")&&a.includes("personalized")&&(s.push("Uses data for targeted advertising"),o-=10),a.includes("location")&&a.includes("collect")&&(s.push("Collects location data"),o-=10),a.includes("opt-out")||a.includes("opt out")||(s.push("Limited opt-out options"),o-=15),a.includes("delete")||a.includes("removal")||(s.push("No clear data deletion process"),o-=10),["google","facebook","amazon","microsoft","adobe","salesforce","analytics","advertising","partners","affiliates","subsidiaries"].forEach((e=>{a.includes(e)&&("google"===e?i.push("Google"):"facebook"===e?i.push("Meta/Facebook"):"amazon"===e?i.push("Amazon"):"microsoft"===e?i.push("Microsoft"):"adobe"===e?i.push("Adobe"):"analytics"===e?i.push("Analytics Providers"):"advertising"===e?i.push("Advertising Networks"):"partners"===e&&i.push("Business Partners"))}));let r="This privacy policy has been analyzed for key privacy practices. ";return r+=o>=80?"The policy shows good privacy practices with clear user rights and limited data sharing.":o>=60?"The policy shows moderate privacy practices but has some concerning data collection or sharing practices.":o>=40?"The policy shows concerning privacy practices with extensive data collection and sharing.":"The policy shows poor privacy practices with significant risks to user privacy.",{score:Math.max(0,Math.min(100,o)),risks:s.slice(0,5),summary:r,dataSharing:[...new Set(i)].slice(0,6)}}}})();