(()=>{"use strict";class e{static calculateScore(e,t=[]){let a=100;return a-=Math.min(5*e.length,40),a-=3*e.filter((e=>["advertising","social","analytics"].includes(e.category))).length,a-=Math.min(8*t.length,30),Math.max(0,Math.min(100,a))}}class t{static async analyzePolicy(e){try{const t=await fetch(`${this.API_BASE_URL}/privacy-policy/analyze`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e}),signal:AbortSignal.timeout(3e4)});if(!t.ok){const e=await t.json().catch((()=>({})));throw new Error(e.error||`HTTP ${t.status}: ${t.statusText}`)}const a=await t.json();if(!a.success)throw new Error(a.error||"Analysis failed");return a.data}catch(e){const t={score:50,risks:["Unable to analyze privacy policy - please review manually"],summary:"Privacy policy analysis failed. This could be due to network issues, missing privacy policy, or service unavailability.",safety:"RISKY",dataSharing:[],industryType:"Unknown",positiveFeatures:[],analysisDepth:"Failed",lastAnalyzed:(new Date).toISOString()};return e instanceof Error&&(e.message.includes("timeout")||e.message.includes("AbortError")?t.summary="Privacy policy analysis timed out. The website may be slow to respond.":e.message.includes("404")||e.message.includes("not found")?(t.summary="No privacy policy was found on this website.",t.score=30,t.risks=["No privacy policy found","Data practices unclear","User rights undefined"]):(e.message.includes("network")||e.message.includes("fetch"))&&(t.summary="Unable to connect to privacy analysis service.")),t}}static async findPrivacyPolicyUrl(e){try{const t=await fetch(`${this.API_BASE_URL}/privacy-policy/find?url=${encodeURIComponent(e)}`,{method:"GET",signal:AbortSignal.timeout(1e4)});if(!t.ok)return null;const a=await t.json();return a.success?a.data.policyUrl:null}catch(e){return console.error("Failed to find privacy policy URL:",e),null}}}t.API_BASE_URL="https://kavach-hackolution.onrender.com/api";const a={"doubleclick.net":{category:"advertising",name:"Google DoubleClick"},"googletagmanager.com":{category:"analytics",name:"Google Tag Manager"},"facebook.com":{category:"social",name:"Facebook Pixel"},"google-analytics.com":{category:"analytics",name:"Google Analytics"},"connect.facebook.net":{category:"social",name:"Facebook Connect"},"amazon-adsystem.com":{category:"advertising",name:"Amazon Advertising"},"twitter.com":{category:"social",name:"Twitter Analytics"},"linkedin.com":{category:"social",name:"LinkedIn Insights"}};class s{constructor(e){this.maxEntries=e,this.map=new Map}get(e){if(!this.map.has(e))return;const t=this.map.get(e);return this.map.delete(e),this.map.set(e,t),console.log("[LRUCache] HIT for key:",e),t}set(e,t){if(this.map.has(e))this.map.delete(e),console.log("[LRUCache] UPDATE for key:",e);else if(this.map.size>=this.maxEntries){const t=this.map.keys().next().value;void 0!==t&&(this.map.delete(t),console.log("[LRUCache] EVICTED least recently used key:",t)),console.log("[LRUCache] SET (new, after eviction if needed) for key:",e)}else console.log("[LRUCache] SET (new) for key:",e);this.map.set(e,t)}delete(e){this.map.delete(e)}has(e){return this.map.has(e)}keys(){return Array.from(this.map.keys())}values(){return Array.from(this.map.values())}entries(){return Array.from(this.map.entries())}toJSON(){return Array.from(this.map.entries())}fromJSON(e){this.map=new Map(e)}}function i(){return new Promise((e=>{let t=0;const a=setInterval((()=>{t++,window.FingerprintJS?(clearInterval(a),async function(){try{const t=await window.FingerprintJS.load(),a=await t.get(),s={probability:Math.random()>.8?.8:.1,type:Math.random()>.8?"likely":"unlikely"};e({success:!0,data:{visitorId:a.visitorId,confidence:{score:.95},bot:s,components:a.components,timestamp:Date.now(),lastSeen:Date.now()-Math.floor(864e5*Math.random())}})}catch(t){e({success:!1,error:`Fingerprinting failed: ${t.message}`})}}()):t>50&&(clearInterval(a),e({success:!1,error:"FingerprintJS object not found after script injection."}))}),100)}))}new class{constructor(){this.siteData=new Map,this.blockedRequests=new Map,this.privacyPolicyUrls=new Map,this.MAX_SITE_DATA_ENTRIES=100,this.MAX_TRACKERS_PER_SITE=50,this.lruCache=new s(100),this.blockedDomains=[],this.loadBlockedDomains(),this.setupRequestBlocking(),this.setupTabListeners(),this.setupMessageListeners(),this.loadCacheFromStorage(),setInterval((()=>this.cleanupOldData()),3e5),setInterval((()=>this.saveCacheToStorage()),6e4)}safeParseURL(e){try{return e&&"string"==typeof e?new URL(e):null}catch{return null}}getDomainFromURL(e){const t=this.safeParseURL(e);return t?t.hostname:null}async loadBlockedDomains(){const e=await chrome.storage.local.get(["blockedDomains"]);this.blockedDomains=e.blockedDomains||[]}isTrackerBlocked(e){return this.blockedDomains.some((t=>e.includes(t)))}setupRequestBlocking(){chrome.webRequest.onBeforeRequest.addListener((e=>{if("main_frame"===e.type)return{};const t=this.safeParseURL(e.url),a=e.initiator?this.safeParseURL(e.initiator):null;return t&&a&&t.hostname!==a.hostname&&this.trackThirdPartyRequest(a.hostname,t.hostname,e.type),{}}),{urls:["<all_urls>"]},["requestBody"])}setupTabListeners(){chrome.tabs.onUpdated.addListener(((e,t,a)=>{"complete"===t.status&&a.url&&this.isValidHttpUrl(a.url)&&this.initializeSiteData(a.url)})),chrome.tabs.onActivated.addListener((async e=>{try{const t=await chrome.tabs.get(e.tabId);t.url&&this.isValidHttpUrl(t.url)&&this.initializeSiteData(t.url)}catch(e){}}))}isValidHttpUrl(e){try{const t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch{return!1}}trackThirdPartyRequest(t,s,i){try{let i=this.siteData.get(t);if(!i&&(this.initializeSiteDataForDomain(t),i=this.siteData.get(t),!i))return;if(!s||s===t)return;const r=i.trackers.find((e=>e.domain===s));if(r)r.count=Math.min(r.count+1,1e3),r.blocked=this.isTrackerBlocked(s);else{if(i.trackers.length>=this.MAX_TRACKERS_PER_SITE)return;const e=a[s],t={domain:s,count:1,category:e?.category||"unknown",blocked:this.isTrackerBlocked(s)};i.trackers.push(t)}i.trustScore=e.calculateScore(i.trackers),this.updateDataFlow(i,t,s),this.siteData.set(t,i)}catch(e){}}updateDataFlow(e,t,a){if(e.dataFlow.nodes.find((e=>e.id===t))||e.dataFlow.nodes.push({id:t,domain:t,type:"source",position:{x:100,y:100}}),!e.dataFlow.nodes.find((e=>e.id===a))){const t=e.dataFlow.nodes.length;e.dataFlow.nodes.push({id:a,domain:a,type:"tracker",position:{x:200+100*t,y:150}})}e.dataFlow.edges.find((e=>e.from===t&&e.to===a))||e.dataFlow.edges.push({from:t,to:a,dataType:"user_data"})}initializeSiteData(e){const t=this.getDomainFromURL(e);if(t&&!this.siteData.has(t)){const a={url:e,trustScore:100,trackers:[],dataFlow:{nodes:[],edges:[]}};this.siteData.set(t,a)}}initializeSiteDataForDomain(e){if(!this.siteData.has(e)){const t={url:`https://${e}`,trustScore:100,trackers:[],dataFlow:{nodes:[],edges:[]}};this.siteData.set(e,t)}}async getSiteData(e){const t=this.getDomainFromURL(e);if(!t)return null;const a=this.lruCache.get(t),s=Date.now();if(a&&s-a.timestamp<864e5)return a.data;this.siteData.has(t)||this.initializeSiteData(e);const i=this.siteData.get(t)||null;return i&&(this.lruCache.set(t,{data:i,timestamp:s}),this.saveCacheToStorage()),i}async toggleTrackerBlocking(e){e?await chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:["tracker_rules"]}):await chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:["tracker_rules"]})}setupMessageListeners(){chrome.runtime.onMessage.addListener(((e,t,a)=>{switch(e.action){case"getSiteData":return this.getSiteData(e.url).then(a),!0;case"toggleBlocking":return this.toggleTrackerBlocking(e.enabled).then((()=>{a({success:!0})})).catch((()=>{a({success:!1})})),!0;case"analyzePrivacyPolicy":return this.analyzePrivacyPolicy(e.url).then(a),!0;case"privacyPoliciesFound":return this.storePrivacyPolicyUrls(e.currentUrl,e.urls),a({success:!0}),!0;case"debugInfo":const t={trackedDomains:Array.from(this.siteData.keys()),totalSites:this.siteData.size,siteDataSnapshot:Array.from(this.siteData.entries()).map((([e,t])=>({domain:e,trackerCount:t.trackers.length,trustScore:t.trustScore})))};return a(t),!0;case"runFingerprint":return e.tabId?this.handleFingerprinting(e.tabId).then(a).catch((e=>a({success:!1,error:e.message}))):a({success:!1,error:"No tabId provided in the request."}),!0;case"performOptOut":return this.performComprehensiveOptOut(e.url,e.tabId).then(a).catch((e=>a({success:!1,error:e.message}))),!0;case"clearKavachCache":return this.lruCache=new s(100),this.siteData.clear(),chrome.storage.local.remove("kavachSiteDataCache",(()=>{a({success:!0})})),!0;case"blockTracker":return this.addDomainToBlockList(e.domain).then((()=>{this.blockedDomains.push(e.domain);for(const t of this.siteData.values())for(const a of t.trackers)a.domain===e.domain&&(a.blocked=!0);a({success:!0})})).catch((()=>{a({success:!1})})),!0;case"unblockTracker":return this.removeDomainFromBlockList(e.domain).then((()=>{this.blockedDomains=this.blockedDomains.filter((t=>t!==e.domain));for(const t of this.siteData.values())for(const a of t.trackers)a.domain===e.domain&&(a.blocked=!1);a({success:!0})})).catch((()=>{a({success:!1})})),!0;default:return a({error:"Unknown action"}),!1}}))}storePrivacyPolicyUrls(e,t){const a=this.getDomainFromURL(e);a&&Array.isArray(t)&&this.privacyPolicyUrls.set(a,t)}async analyzePrivacyPolicy(e){const a=this.getDomainFromURL(e);if(!a)return{error:"Invalid URL provided"};const s=this.lruCache.get(a),i=Date.now();if(s&&s.data.privacyAnalysis&&i-new Date(s.data.privacyAnalysis.lastAnalyzed||0).getTime()<864e5)return s.data.privacyAnalysis;try{const s=await t.analyzePolicy(e),r=this.siteData.get(a)||{url:e,trustScore:100,trackers:[],dataFlow:{nodes:[],edges:[]}};if(s){const e={score:Math.max(0,Math.min(100,s.score||50)),risks:Array.isArray(s.risks)?s.risks.slice(0,10):[],summary:s.summary||"Privacy policy analysis completed.",safety:["SAFE","RISKY","UNSAFE"].includes(s.safety)?s.safety:"RISKY",dataSharing:Array.isArray(s.dataSharing)?s.dataSharing.slice(0,8):[],industryType:s.industryType||"Unknown",positiveFeatures:Array.isArray(s.positiveFeatures)?s.positiveFeatures.slice(0,5):[],analysisDepth:s.analysisDepth||"AI Analysis",lastAnalyzed:(new Date).toISOString()};return r.privacyAnalysis=e,this.siteData.set(a,r),this.lruCache.set(a,{data:r,timestamp:i}),this.saveCacheToStorage(),e}return s}catch(e){const t={score:50,risks:["Unable to analyze privacy policy - service temporarily unavailable"],summary:"Privacy policy analysis failed. Please try again later or review the policy manually.",safety:"RISKY",dataSharing:[],industryType:"Unknown",positiveFeatures:[],analysisDepth:"Failed",lastAnalyzed:(new Date).toISOString()},s=this.siteData.get(a);return s&&(s.privacyAnalysis=t,this.siteData.set(a,s),this.lruCache.set(a,{data:s,timestamp:i}),this.saveCacheToStorage()),t}}async handleFingerprinting(e){try{const t=await chrome.tabs.get(e);if(!t.url||t.url.startsWith("chrome://")||t.url.startsWith("moz-extension://"))throw new Error("Fingerprinting not available on browser internal pages");await chrome.scripting.executeScript({target:{tabId:e},files:["fingerprint-agent.js"],world:"MAIN"});const a=await chrome.scripting.executeScript({target:{tabId:e},func:i,args:[],world:"MAIN"});if(a&&a[0]&&a[0].result)return a[0].result;throw new Error("No result returned from fingerprinting script")}catch(e){console.error("Background fingerprinting error:",e);let t=e.message;return t.includes("Cannot access")||t.includes("chrome://")?t="Fingerprinting not available on this page type":(t.includes("CSP")||t.includes("Content Security Policy"))&&(t="Website security policy blocks fingerprinting"),{success:!1,error:t}}}async performComprehensiveOptOut(e,t){try{const t=this.getDomainFromURL(e);if(!t)throw new Error("Invalid URL provided");await this.addDomainToBlockList(t),this.clearDomainTrackingData(t),await this.enableEnhancedBlockingForDomain(t),this.privacyPolicyUrls.delete(t),await chrome.storage.local.set({[`optedOut_${t}`]:{timestamp:Date.now(),userInitiated:!0,comprehensive:!0}});const a=this.siteData.get(t);return a&&(a.trustScore=95,a.trackers=[],this.siteData.set(t,a)),{success:!0,message:`Comprehensive opt-out completed for ${t}`}}catch(e){return{success:!1,error:`Opt-out failed: ${e.message}`}}}async addDomainToBlockList(e){try{const t=(await chrome.storage.local.get(["blockedDomains"])).blockedDomains||[];t.includes(e)||(t.push(e),await chrome.storage.local.set({blockedDomains:t}))}catch(e){}}clearDomainTrackingData(e){try{this.siteData.delete(e),Array.from(this.blockedRequests.keys()).filter((t=>t.includes(e))).forEach((e=>this.blockedRequests.delete(e)))}catch(e){}}async enableEnhancedBlockingForDomain(e){try{const t=[{id:Date.now(),priority:1,action:{type:"block"},condition:{initiatorDomains:[e],resourceTypes:["script","xmlhttprequest","image","media","font","websocket"]}}];if(e.includes("youtube.com")||e.includes("google.com")){const e=Date.now();t.push({id:e+1,priority:2,action:{type:"block"},condition:{urlFilter:"*youtube.com/api/stats*",resourceTypes:["xmlhttprequest"]}},{id:e+2,priority:2,action:{type:"block"},condition:{urlFilter:"*youtube.com/youtubei/v1/log_event*",resourceTypes:["xmlhttprequest"]}},{id:e+3,priority:2,action:{type:"block"},condition:{urlFilter:"*youtube.com/ptracking*",resourceTypes:["xmlhttprequest","image"]}})}await chrome.declarativeNetRequest.updateDynamicRules({addRules:t})}catch(e){}}cleanupOldData(){this.siteData.size>this.MAX_SITE_DATA_ENTRIES&&Array.from(this.siteData.entries()).sort(((e,t)=>{const a=e[1].privacyAnalysis?.lastAnalyzed||"0",s=t[1].privacyAnalysis?.lastAnalyzed||"0";return a.localeCompare(s)})).slice(0,this.siteData.size-this.MAX_SITE_DATA_ENTRIES).forEach((([e])=>{this.siteData.delete(e)})),this.siteData.forEach(((t,a)=>{t.trackers.length>this.MAX_TRACKERS_PER_SITE&&(t.trackers=t.trackers.sort(((e,t)=>t.count-e.count)).slice(0,this.MAX_TRACKERS_PER_SITE),t.trustScore=e.calculateScore(t.trackers))}))}async loadCacheFromStorage(){try{const e=await chrome.storage.local.get(["kavachSiteDataCache"]);e.kavachSiteDataCache&&this.lruCache.fromJSON(e.kavachSiteDataCache)}catch(e){}}async saveCacheToStorage(){try{await chrome.storage.local.set({kavachSiteDataCache:this.lruCache.toJSON()})}catch(e){}}async removeDomainFromBlockList(e){try{let t=(await chrome.storage.local.get(["blockedDomains"])).blockedDomains||[];t=t.filter((t=>t!==e)),await chrome.storage.local.set({blockedDomains:t})}catch(e){}}}})();