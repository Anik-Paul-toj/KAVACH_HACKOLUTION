(()=>{"use strict";class t{static calculateScore(t,e=[]){let a=100;return a-=Math.min(5*t.length,40),a-=3*t.filter((t=>["advertising","social","analytics"].includes(t.category))).length,a-=Math.min(8*e.length,30),Math.max(0,Math.min(100,a))}}class e{static async analyzePolicy(t){try{const e=await fetch(`${this.API_BASE_URL}/privacy-policy/analyze`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t}),signal:AbortSignal.timeout(3e4)});if(!e.ok){const t=await e.json().catch((()=>({})));throw new Error(t.error||`HTTP ${e.status}: ${e.statusText}`)}const a=await e.json();if(!a.success)throw new Error(a.error||"Analysis failed");return a.data}catch(t){const e={score:50,risks:["Unable to analyze privacy policy - please review manually"],summary:"Privacy policy analysis failed. This could be due to network issues, missing privacy policy, or service unavailability.",safety:"RISKY",dataSharing:[],industryType:"Unknown",positiveFeatures:[],analysisDepth:"Failed",lastAnalyzed:(new Date).toISOString()};return t instanceof Error&&(t.message.includes("timeout")||t.message.includes("AbortError")?e.summary="Privacy policy analysis timed out. The website may be slow to respond.":t.message.includes("404")||t.message.includes("not found")?(e.summary="No privacy policy was found on this website.",e.score=30,e.risks=["No privacy policy found","Data practices unclear","User rights undefined"]):(t.message.includes("network")||t.message.includes("fetch"))&&(e.summary="Unable to connect to privacy analysis service.")),e}}static async findPrivacyPolicyUrl(t){try{const e=await fetch(`${this.API_BASE_URL}/privacy-policy/find?url=${encodeURIComponent(t)}`,{method:"GET",signal:AbortSignal.timeout(1e4)});if(!e.ok)return null;const a=await e.json();return a.success?a.data.policyUrl:null}catch(t){return console.error("Failed to find privacy policy URL:",t),null}}}e.API_BASE_URL="https://kavach-hackolution.onrender.com/api";const a={"doubleclick.net":{category:"advertising",name:"Google DoubleClick"},"googletagmanager.com":{category:"analytics",name:"Google Tag Manager"},"facebook.com":{category:"social",name:"Facebook Pixel"},"google-analytics.com":{category:"analytics",name:"Google Analytics"},"connect.facebook.net":{category:"social",name:"Facebook Connect"},"amazon-adsystem.com":{category:"advertising",name:"Amazon Advertising"},"twitter.com":{category:"social",name:"Twitter Analytics"},"linkedin.com":{category:"social",name:"LinkedIn Insights"}};function s(){return new Promise((t=>{let e=0;const a=setInterval((()=>{e++,window.FingerprintJS?(clearInterval(a),async function(){try{const e=await window.FingerprintJS.load(),a=await e.get(),s={probability:Math.random()>.8?.8:.1,type:Math.random()>.8?"likely":"unlikely"};t({success:!0,data:{visitorId:a.visitorId,confidence:{score:.95},bot:s,components:a.components,timestamp:Date.now(),lastSeen:Date.now()-Math.floor(864e5*Math.random())}})}catch(e){t({success:!1,error:`Fingerprinting failed: ${e.message}`})}}()):e>50&&(clearInterval(a),t({success:!1,error:"FingerprintJS object not found after script injection."}))}),100)}))}new class{constructor(){this.siteData=new Map,this.blockedRequests=new Map,this.privacyPolicyUrls=new Map,this.MAX_SITE_DATA_ENTRIES=100,this.MAX_TRACKERS_PER_SITE=50,this.setupRequestBlocking(),this.setupTabListeners(),this.setupMessageListeners(),setInterval((()=>this.cleanupOldData()),3e5)}safeParseURL(t){try{return t&&"string"==typeof t?new URL(t):null}catch{return null}}getDomainFromURL(t){const e=this.safeParseURL(t);return e?e.hostname:null}setupRequestBlocking(){chrome.webRequest.onBeforeRequest.addListener((t=>{if("main_frame"===t.type)return{};const e=this.safeParseURL(t.url),a=t.initiator?this.safeParseURL(t.initiator):null;return e&&a&&e.hostname!==a.hostname&&this.trackThirdPartyRequest(a.hostname,e.hostname,t.type),{}}),{urls:["<all_urls>"]},["requestBody"])}setupTabListeners(){chrome.tabs.onUpdated.addListener(((t,e,a)=>{"complete"===e.status&&a.url&&this.isValidHttpUrl(a.url)&&this.initializeSiteData(a.url)})),chrome.tabs.onActivated.addListener((async t=>{try{const e=await chrome.tabs.get(t.tabId);e.url&&this.isValidHttpUrl(e.url)&&this.initializeSiteData(e.url)}catch(t){}}))}isValidHttpUrl(t){try{const e=new URL(t);return"http:"===e.protocol||"https:"===e.protocol}catch{return!1}}trackThirdPartyRequest(e,s,i){try{let i=this.siteData.get(e);if(!i&&(this.initializeSiteDataForDomain(e),i=this.siteData.get(e),!i))return;if(!s||s===e)return;const r=i.trackers.find((t=>t.domain===s));if(r)r.count=Math.min(r.count+1,1e3);else{if(i.trackers.length>=this.MAX_TRACKERS_PER_SITE)return;const t=a[s],e={domain:s,count:1,category:t?.category||"unknown",blocked:this.isTrackerBlocked(s)};i.trackers.push(e)}i.trustScore=t.calculateScore(i.trackers),this.updateDataFlow(i,e,s),this.siteData.set(e,i)}catch(t){}}isTrackerBlocked(t){return["doubleclick.net","googletagmanager.com","facebook.com/tr"].some((e=>t.includes(e)))}updateDataFlow(t,e,a){if(t.dataFlow.nodes.find((t=>t.id===e))||t.dataFlow.nodes.push({id:e,domain:e,type:"source",position:{x:100,y:100}}),!t.dataFlow.nodes.find((t=>t.id===a))){const e=t.dataFlow.nodes.length;t.dataFlow.nodes.push({id:a,domain:a,type:"tracker",position:{x:200+100*e,y:150}})}t.dataFlow.edges.find((t=>t.from===e&&t.to===a))||t.dataFlow.edges.push({from:e,to:a,dataType:"user_data"})}initializeSiteData(t){const e=this.getDomainFromURL(t);if(e&&!this.siteData.has(e)){const a={url:t,trustScore:100,trackers:[],dataFlow:{nodes:[],edges:[]}};this.siteData.set(e,a)}}initializeSiteDataForDomain(t){if(!this.siteData.has(t)){const e={url:`https://${t}`,trustScore:100,trackers:[],dataFlow:{nodes:[],edges:[]}};this.siteData.set(t,e)}}async getSiteData(t){const e=this.getDomainFromURL(t);return e?(this.siteData.has(e)||this.initializeSiteData(t),this.siteData.get(e)||null):null}async toggleTrackerBlocking(t){t?await chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:["tracker_rules"]}):await chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:["tracker_rules"]})}setupMessageListeners(){chrome.runtime.onMessage.addListener(((t,e,a)=>{switch(t.action){case"getSiteData":return this.getSiteData(t.url).then(a),!0;case"toggleBlocking":return this.toggleTrackerBlocking(t.enabled).then((()=>{a({success:!0})})).catch((()=>{a({success:!1})})),!0;case"analyzePrivacyPolicy":return this.analyzePrivacyPolicy(t.url).then(a),!0;case"privacyPoliciesFound":return this.storePrivacyPolicyUrls(t.currentUrl,t.urls),a({success:!0}),!0;case"debugInfo":const e={trackedDomains:Array.from(this.siteData.keys()),totalSites:this.siteData.size,siteDataSnapshot:Array.from(this.siteData.entries()).map((([t,e])=>({domain:t,trackerCount:e.trackers.length,trustScore:e.trustScore})))};return a(e),!0;case"runFingerprint":return t.tabId?this.handleFingerprinting(t.tabId).then(a).catch((t=>a({success:!1,error:t.message}))):a({success:!1,error:"No tabId provided in the request."}),!0;case"performOptOut":return this.performComprehensiveOptOut(t.url,t.tabId).then(a).catch((t=>a({success:!1,error:t.message}))),!0;default:return a({error:"Unknown action"}),!1}}))}storePrivacyPolicyUrls(t,e){const a=this.getDomainFromURL(t);a&&Array.isArray(e)&&this.privacyPolicyUrls.set(a,e)}async analyzePrivacyPolicy(t){const a=this.getDomainFromURL(t);if(!a)return{error:"Invalid URL provided"};try{const s=await e.analyzePolicy(t),i=this.siteData.get(a);if(i&&s){const t={score:Math.max(0,Math.min(100,s.score||50)),risks:Array.isArray(s.risks)?s.risks.slice(0,10):[],summary:s.summary||"Privacy policy analysis completed.",safety:["SAFE","RISKY","UNSAFE"].includes(s.safety)?s.safety:"RISKY",dataSharing:Array.isArray(s.dataSharing)?s.dataSharing.slice(0,8):[],industryType:s.industryType||"Unknown",positiveFeatures:Array.isArray(s.positiveFeatures)?s.positiveFeatures.slice(0,5):[],analysisDepth:s.analysisDepth||"AI Analysis",lastAnalyzed:(new Date).toISOString()};return i.privacyAnalysis=t,this.siteData.set(a,i),t}return s}catch(t){const e={score:50,risks:["Unable to analyze privacy policy - service temporarily unavailable"],summary:"Privacy policy analysis failed. Please try again later or review the policy manually.",safety:"RISKY",dataSharing:[],industryType:"Unknown",positiveFeatures:[],analysisDepth:"Failed",lastAnalyzed:(new Date).toISOString()},s=this.siteData.get(a);return s&&(s.privacyAnalysis=e,this.siteData.set(a,s)),e}}async handleFingerprinting(t){try{const e=await chrome.tabs.get(t);if(!e.url||e.url.startsWith("chrome://")||e.url.startsWith("moz-extension://"))throw new Error("Fingerprinting not available on browser internal pages");await chrome.scripting.executeScript({target:{tabId:t},files:["fingerprint-agent.js"],world:"MAIN"});const a=await chrome.scripting.executeScript({target:{tabId:t},func:s,args:[],world:"MAIN"});if(a&&a[0]&&a[0].result)return a[0].result;throw new Error("No result returned from fingerprinting script")}catch(t){console.error("Background fingerprinting error:",t);let e=t.message;return e.includes("Cannot access")||e.includes("chrome://")?e="Fingerprinting not available on this page type":(e.includes("CSP")||e.includes("Content Security Policy"))&&(e="Website security policy blocks fingerprinting"),{success:!1,error:e}}}async performComprehensiveOptOut(t,e){try{const e=this.getDomainFromURL(t);if(!e)throw new Error("Invalid URL provided");await this.addDomainToBlockList(e),this.clearDomainTrackingData(e),await this.enableEnhancedBlockingForDomain(e),this.privacyPolicyUrls.delete(e),await chrome.storage.local.set({[`optedOut_${e}`]:{timestamp:Date.now(),userInitiated:!0,comprehensive:!0}});const a=this.siteData.get(e);return a&&(a.trustScore=95,a.trackers=[],this.siteData.set(e,a)),{success:!0,message:`Comprehensive opt-out completed for ${e}`}}catch(t){return{success:!1,error:`Opt-out failed: ${t.message}`}}}async addDomainToBlockList(t){try{const e=(await chrome.storage.local.get(["blockedDomains"])).blockedDomains||[];e.includes(t)||(e.push(t),await chrome.storage.local.set({blockedDomains:e}))}catch(t){}}clearDomainTrackingData(t){try{this.siteData.delete(t),Array.from(this.blockedRequests.keys()).filter((e=>e.includes(t))).forEach((t=>this.blockedRequests.delete(t)))}catch(t){}}async enableEnhancedBlockingForDomain(t){try{const e=[{id:Date.now(),priority:1,action:{type:"block"},condition:{initiatorDomains:[t],resourceTypes:["script","xmlhttprequest","image","media","font","websocket"]}}];if(t.includes("youtube.com")||t.includes("google.com")){const t=Date.now();e.push({id:t+1,priority:2,action:{type:"block"},condition:{urlFilter:"*youtube.com/api/stats*",resourceTypes:["xmlhttprequest"]}},{id:t+2,priority:2,action:{type:"block"},condition:{urlFilter:"*youtube.com/youtubei/v1/log_event*",resourceTypes:["xmlhttprequest"]}},{id:t+3,priority:2,action:{type:"block"},condition:{urlFilter:"*youtube.com/ptracking*",resourceTypes:["xmlhttprequest","image"]}})}await chrome.declarativeNetRequest.updateDynamicRules({addRules:e})}catch(t){}}cleanupOldData(){this.siteData.size>this.MAX_SITE_DATA_ENTRIES&&Array.from(this.siteData.entries()).sort(((t,e)=>{const a=t[1].privacyAnalysis?.lastAnalyzed||"0",s=e[1].privacyAnalysis?.lastAnalyzed||"0";return a.localeCompare(s)})).slice(0,this.siteData.size-this.MAX_SITE_DATA_ENTRIES).forEach((([t])=>{this.siteData.delete(t)})),this.siteData.forEach(((e,a)=>{e.trackers.length>this.MAX_TRACKERS_PER_SITE&&(e.trackers=e.trackers.sort(((t,e)=>e.count-t.count)).slice(0,this.MAX_TRACKERS_PER_SITE),e.trustScore=t.calculateScore(e.trackers))}))}}})();