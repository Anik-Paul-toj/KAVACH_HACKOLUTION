(()=>{"use strict";class e{static calculateScore(e,t=[]){let a=100;return a-=Math.min(5*e.length,40),a-=3*e.filter((e=>["advertising","social","analytics"].includes(e.category))).length,a-=Math.min(8*t.length,30),Math.max(0,Math.min(100,a))}}const t={"doubleclick.net":{category:"advertising",name:"Google DoubleClick"},"googletagmanager.com":{category:"analytics",name:"Google Tag Manager"},"facebook.com":{category:"social",name:"Facebook Pixel"},"google-analytics.com":{category:"analytics",name:"Google Analytics"},"connect.facebook.net":{category:"social",name:"Facebook Connect"},"amazon-adsystem.com":{category:"advertising",name:"Amazon Advertising"},"twitter.com":{category:"social",name:"Twitter Analytics"},"linkedin.com":{category:"social",name:"LinkedIn Insights"}},a=new class{constructor(){this.siteData=new Map,this.blockedRequests=new Map,this.setupRequestBlocking(),this.setupTabListeners()}setupRequestBlocking(){chrome.webRequest.onBeforeRequest.addListener((e=>{if("main_frame"===e.type)return{};const t=new URL(e.url),a=e.initiator?new URL(e.initiator):null;return a&&t.hostname!==a.hostname&&this.trackThirdPartyRequest(a.hostname,t.hostname,e.type),{}}),{urls:["<all_urls>"]},["requestBody"])}setupTabListeners(){chrome.tabs.onUpdated.addListener(((e,t,a)=>{"complete"===t.status&&a.url&&this.initializeSiteData(a.url)}))}trackThirdPartyRequest(a,s,o){const n=this.siteData.get(a);if(!n)return;const i=n.trackers.find((e=>e.domain===s));if(i)i.count++;else{const e=t[s];n.trackers.push({domain:s,count:1,category:e?.category||"unknown",blocked:this.isTrackerBlocked(s)})}n.trustScore=e.calculateScore(n.trackers),this.updateDataFlow(n,a,s),this.siteData.set(a,n)}isTrackerBlocked(e){return["doubleclick.net","googletagmanager.com","facebook.com/tr"].some((t=>e.includes(t)))}updateDataFlow(e,t,a){if(e.dataFlow.nodes.find((e=>e.id===t))||e.dataFlow.nodes.push({id:t,domain:t,type:"source",position:{x:100,y:100}}),!e.dataFlow.nodes.find((e=>e.id===a))){const t=e.dataFlow.nodes.length;e.dataFlow.nodes.push({id:a,domain:a,type:"tracker",position:{x:200+100*t,y:150}})}e.dataFlow.edges.find((e=>e.from===t&&e.to===a))||e.dataFlow.edges.push({from:t,to:a,dataType:"user_data"})}initializeSiteData(e){const t=new URL(e).hostname;this.siteData.has(t)||this.siteData.set(t,{url:e,trustScore:100,trackers:[],dataFlow:{nodes:[],edges:[]}})}async getSiteData(e){const t=new URL(e).hostname;return this.siteData.get(t)||null}async toggleTrackerBlocking(e){e?await chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:["tracker_rules"]}):await chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:["tracker_rules"]})}};chrome.runtime.onMessage.addListener(((e,t,s)=>{switch(e.action){case"getSiteData":return a.getSiteData(e.url).then(s),!0;case"toggleBlocking":return a.toggleTrackerBlocking(e.enabled).then((()=>{s({success:!0})})),!0}}))})();