(()=>{"use strict";(new class{constructor(){this.privacyPolicyUrls=[],this.optedOutDomains=new Set,console.log("🔍 Kavach Content Script starting on:",window.location.href),this.checkOptOutStatus(),this.detectPrivacyPolicies(),this.injectTrackingDetector(),this.setupOptOutListeners(),console.log("✅ Kavach Content Script initialized")}async checkOptOutStatus(){const e=window.location.hostname;try{(await chrome.storage.local.get([`optedOut_${e}`]))[`optedOut_${e}`]&&(this.optedOutDomains.add(e),console.log("🚫 Domain is opted out:",e),this.enforceOptOutState())}catch(e){console.log("Could not check opt-out status:",e)}}enforceOptOutState(){new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{if(e.nodeType===Node.ELEMENT_NODE){const t=e;if("SCRIPT"===t.tagName){const e=t,o=e.src?.toLowerCase()||"",c=e.textContent?.toLowerCase()||"";["google-analytics","googletagmanager","gtag","ga(","facebook.com/tr","connect.facebook","fbq(","doubleclick","adsystem","googlesyndication"].some((e=>o.includes(e)||c.includes(e)))&&(e.remove(),console.log("🚫 Blocked tracking script:",o.substring(0,50)))}if("IMG"===t.tagName){const e=t,o=e.src?.toLowerCase()||"";(o.includes("track")||o.includes("pixel")||o.includes("beacon"))&&(e.remove(),console.log("🚫 Blocked tracking pixel:",o.substring(0,50)))}}}))}))})).observe(document,{childList:!0,subtree:!0})}setupOptOutListeners(){chrome.runtime.onMessage.addListener(((e,t,o)=>{"performOptOut"===e.action&&(this.handleOptOutRequest(),o({success:!0}))}))}handleOptOutRequest(){this.clickConsentButtons(),this.disableTrackingMethods(),this.clearPageStorage()}clickConsentButtons(){setTimeout((()=>{const e=['button[data-testid*="reject"]','button[data-testid*="decline"]','button[data-testid*="opt-out"]','[data-cy*="reject"]','[data-cy*="decline"]','[aria-label="Reject all"]','[data-testid="reject-all-button"]','button[jsname="b3VHJd"]','button[data-value="2"]','.VfPpkd-LgbsSe[aria-label*="Reject"]',".QS5gu",'[jsaction*="reject"]','c-wiz button[aria-label*="Reject"]','form[action*="consent"] button:last-child',"#onetrust-reject-all-handler",".optanon-category-2",".optanon-category-3",".optanon-category-4",'[data-cy="manage-consent-reject-all"]',".sp_choice_type_REJECT_ALL","#truste-consent-required",'.cookie-banner button[data-role="reject"]',".gdpr-banner .reject-all",".consent-manager .decline-all"],t=()=>{e.forEach((e=>{document.querySelectorAll(e).forEach((t=>{try{t.click(),console.log("🖱️ Clicked consent button:",e)}catch(e){}}))})),window.location.hostname.includes("youtube.com")&&document.querySelectorAll('button, [role="button"]').forEach((e=>{const t=e.textContent?.toLowerCase()||"",o=e.getAttribute("aria-label")?.toLowerCase()||"";if(t.includes("reject all")||t.includes("turn off")||o.includes("reject all")||t.includes("no thanks"))try{e.click(),console.log("🖱️ Clicked YouTube consent button:",t.substring(0,30))}catch(e){}}))};t(),setTimeout(t,1e3),setTimeout(t,3e3),setTimeout(t,5e3)}),1e3)}disableTrackingMethods(){["gtag","ga","fbq","_paq","mixpanel"].forEach((e=>{window[e]&&(window[e]=()=>console.log(`Tracking method ${e} disabled by Kavach`))}))}clearPageStorage(){try{localStorage.clear(),sessionStorage.clear(),console.log("🧹 Cleared page storage")}catch(e){console.log("Could not clear page storage:",e)}}detectPrivacyPolicies(){const e=["privacy policy","privacy statement","privacy notice","terms of service","terms and conditions","data policy","cookie policy","legal","gdpr","ccpa"];['a[href*="privacy"]','a[href*="terms"]','a[href*="policy"]','a[href*="legal"]','a[href*="gdpr"]','a[href*="ccpa"]'].forEach((t=>{document.querySelectorAll(t).forEach((t=>{const o=t.href,c=t.textContent?.toLowerCase()||"";o&&!this.privacyPolicyUrls.includes(o)&&e.some((e=>c.includes(e)||o.toLowerCase().includes(e)))&&this.privacyPolicyUrls.push(o)}))})),document.querySelectorAll('footer, .footer, [class*="footer"]').forEach((t=>{t.querySelectorAll("a").forEach((t=>{const o=t.href,c=t.textContent?.toLowerCase()||"";o&&!this.privacyPolicyUrls.includes(o)&&e.some((e=>c.includes(e)))&&this.privacyPolicyUrls.push(o)}))})),this.privacyPolicyUrls.length>0&&chrome.runtime.sendMessage({action:"privacyPoliciesFound",urls:this.privacyPolicyUrls,currentUrl:window.location.href}).catch((e=>{console.log("Failed to send privacy policy URLs:",e)}))}injectTrackingDetector(){const e=document.createElement("script");e.src=chrome.runtime.getURL("injected.js"),e.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(e)}init(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{setTimeout((()=>{this.detectPrivacyPolicies()}),1e3)})):setTimeout((()=>{this.detectPrivacyPolicies()}),1e3),setTimeout((()=>{this.detectPrivacyPolicies()}),3e3)}}).init()})();